---

---

<div class="theme-toggle" id="theme-toggle-container" data-main-instance="true">
    <script is:inline>
        (function () {
            const container = document.currentScript.parentElement;
            const theme = localStorage.getItem("theme") || "system";
            container.setAttribute("data-active-theme", theme);
        })();
    </script>
    <div class="theme-toggle-bg"></div>
    <button class="theme-light" title="Light Theme" aria-label="Light Theme">
        <i class="fa-solid fa-sun"></i>
    </button>
    <button class="theme-system" title="System Theme" aria-label="System Theme">
        <i class="fa-solid fa-desktop"></i>
    </button>
    <button class="theme-dark" title="Dark Theme" aria-label="Dark Theme">
        <i class="fa-solid fa-moon"></i>
    </button>
</div>

<script>
    function initThemeToggles() {
        // Collect all toggle instances
        const containers = document.querySelectorAll(".theme-toggle");

        containers.forEach((container) => {
            if (!(container instanceof HTMLElement)) return;

            const lightBtn = container.querySelector(".theme-light");
            const systemBtn = container.querySelector(".theme-system");
            const darkBtn = container.querySelector(".theme-dark");

            function updateTheme(value: string) {
                localStorage.setItem("theme", value);

                // Enable transition only for the toggle action
                document.documentElement.classList.add("theme-transition");

                // Set state on ALL containers to sync UI
                document.querySelectorAll(".theme-toggle").forEach((c) => {
                    c.setAttribute("data-active-theme", value);
                    c.classList.add("animate");
                });

                const systemDark = window.matchMedia(
                    "(prefers-color-scheme: dark)",
                ).matches;
                if (value === "dark" || (value === "system" && systemDark)) {
                    document.documentElement.setAttribute("data-theme", "dark");
                } else {
                    document.documentElement.removeAttribute("data-theme");
                }

                // Remove transition class after animation
                setTimeout(() => {
                    document.documentElement.classList.remove(
                        "theme-transition",
                    );
                    document.querySelectorAll(".theme-toggle").forEach((c) => {
                        c.classList.remove("animate");
                    });
                }, 400);
            }

            // Only attach listeners once per element
            if (!container.dataset.initialized) {
                lightBtn?.addEventListener("click", () => updateTheme("light"));
                systemBtn?.addEventListener("click", () =>
                    updateTheme("system"),
                );
                darkBtn?.addEventListener("click", () => updateTheme("dark"));

                if (container.dataset.mainInstance === "true") {
                    window
                        .matchMedia("(prefers-color-scheme: dark)")
                        .addEventListener("change", (e) => {
                            if (localStorage.getItem("theme") === "system") {
                                if (e.matches) {
                                    document.documentElement.setAttribute(
                                        "data-theme",
                                        "dark",
                                    );
                                } else {
                                    document.documentElement.removeAttribute(
                                        "data-theme",
                                    );
                                }
                            }
                        });
                }

                container.dataset.initialized = "true";
            }

            // Sync UI with current selection
            const currentTheme = localStorage.getItem("theme") || "system";
            container.setAttribute("data-active-theme", currentTheme);
        });
    }

    // Initialize (runs on script load and after view transitions)
    initThemeToggles();
    document.addEventListener("astro:after-swap", initThemeToggles);
</script>

<style>
    .theme-toggle {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        background: var(--surface-container-high);
        border-radius: 9999px;
        padding: 4px;
        gap: 2px;
        position: relative;
        width: fit-content;
        isolation: isolate;
        border: 1px solid var(--outline-variant);
    }

    .theme-toggle-bg {
        position: absolute;
        top: 4px;
        left: 4px;
        width: calc((100% - 8px - 4px) / 3);
        height: calc(100% - 8px);
        border-radius: 9999px;
        background: var(--secondary);
        box-shadow: 0 2px 4px color-mix(in srgb, var(--shadow), transparent 80%);
        z-index: 1;
        pointer-events: none;
    }

    .theme-toggle.animate .theme-toggle-bg {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Transform positions based on data-active-theme */
    .theme-toggle[data-active-theme="light"] .theme-toggle-bg {
        transform: translateX(0%);
    }

    .theme-toggle[data-active-theme="system"] .theme-toggle-bg {
        transform: translateX(calc(100% + 2px));
    }

    .theme-toggle[data-active-theme="dark"] .theme-toggle-bg {
        transform: translateX(calc(200% + 4px));
    }

    button {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 6px;
        border-radius: 9999px;
        color: var(--on-surface-variant);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        position: relative;
        z-index: 2;
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
        outline: none;
        user-select: none;
    }

    button:active {
        background: color-mix(in srgb, var(--primary), transparent 85%);
    }

    button:hover {
        color: var(--primary);
    }

    .theme-toggle[data-active-theme="light"] .theme-light,
    .theme-toggle[data-active-theme="system"] .theme-system,
    .theme-toggle[data-active-theme="dark"] .theme-dark {
        color: var(--on-secondary);
    }

    [data-theme="dark"] .theme-toggle {
        background: rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .theme-toggle-bg {
        background: var(--secondary);
    }

    [data-theme="dark"] button {
        color: var(--on-surface-variant);
    }

    [data-theme="dark"] .theme-toggle[data-active-theme="light"] .theme-light,
    [data-theme="dark"] .theme-toggle[data-active-theme="system"] .theme-system,
    [data-theme="dark"] .theme-toggle[data-active-theme="dark"] .theme-dark {
        color: var(--on-secondary);
    }
</style>
