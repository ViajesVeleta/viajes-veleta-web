---
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import "../styles/global.css";
import type { ImageMetadata } from "astro";
import FallbackImage from "../assets/blog-placeholder-1.webp";
import { SITE_TITLE } from "../consts";
import { ClientRouter } from "astro:transitions";
import "@fortawesome/fontawesome-free/css/all.min.css";

interface Props {
	title: string;
	description: string;
	image?: ImageMetadata;
	// Language-specific images for social media sharing
	imageEs?: ImageMetadata;
	imageEn?: ImageMetadata;
	translatedPaths?: Record<string, string>;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const {
	title,
	description,
	image = FallbackImage,
	imageEs,
	imageEn,
	translatedPaths,
} = Astro.props;

// Get current language from URL
import { getLangFromUrl } from "../i18n/utils";
const lang = getLangFromUrl(Astro.url);

// Select language-specific image if available, otherwise use default
const ogImage =
	lang === "es" ? imageEs || image : lang === "en" ? imageEn || image : image;
---

<ClientRouter />

<!-- Theme Initialization -->
<script is:inline>
	const applyTheme = () => {
		const theme = localStorage.getItem("theme") || "system";
		const systemDark = window.matchMedia(
			"(prefers-color-scheme: dark)",
		).matches;

		if (theme === "dark" || (theme === "system" && systemDark)) {
			document.documentElement.setAttribute("data-theme", "dark");
		} else {
			document.documentElement.removeAttribute("data-theme");
		}
	};

	applyTheme();
	document.addEventListener("astro:after-swap", applyTheme);
</script>

<!-- Automatic Language Detection -->
<script is:inline>
	// Only run on first visit to the site (root page without language prefix)
	(function () {
		const currentPath = window.location.pathname;
		const hasLanguagePrefix = /^\/(en|es)(\/|$)/.test(currentPath);

		// Only redirect if we're on the root Spanish site (no language prefix)
		// and user hasn't been redirected before
		if (!hasLanguagePrefix && currentPath === "/") {
			const hasVisited = localStorage.getItem("language-detected");

			if (!hasVisited) {
				// Get browser language
				const browserLang =
					navigator.language || navigator.userLanguage;
				const langCode = browserLang.split("-")[0].toLowerCase();

				// Supported languages
				const supportedLangs = ["es", "en"];
				const defaultLang = "es";

				// Determine target language
				let targetLang = supportedLangs.includes(langCode)
					? langCode
					: defaultLang;

				// Mark that we've detected language
				localStorage.setItem("language-detected", "true");

				// Only redirect if browser language is different from default (Spanish)
				if (targetLang !== defaultLang) {
					window.location.href = `/${targetLang}/`;
				}
			}
		}
	})();
</script>

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="sitemap" href="/sitemap-index.xml" />
<link
	rel="alternate"
	type="application/rss+xml"
	title={`${SITE_TITLE}${lang === "en" ? " - English" : ""}`}
	href={new URL(lang === "en" ? "en/rss.xml" : "rss.xml", Astro.site)}
/>
<meta name="generator" content={Astro.generator} />

<!-- DNS Prefetch & Preconnect for External Resources -->
<link rel="dns-prefetch" href="https://fonts.googleapis.com" />
<link rel="dns-prefetch" href="https://fonts.gstatic.com" />
<link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />

<!-- Lato & Playfair Display Fonts -->
<link
	rel="preload"
	as="style"
	href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
	onload="this.onload=null;this.rel='stylesheet'"
/>
<noscript>
	<link
		href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
		rel="stylesheet"
	/>
</noscript>

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Alternate URLs -->
{
	translatedPaths && (
		<>
			{Object.entries(translatedPaths).map(([lang, path]) => (
				<link
					rel="alternate"
					hreflang={lang}
					href={new URL(path, Astro.site)}
				/>
			))}
			<link
				rel="alternate"
				hreflang="x-default"
				href={
					new URL(
						translatedPaths.es ||
							translatedPaths[Object.keys(translatedPaths)[0]],
						Astro.site,
					)
				}
			/>
		</>
	)
}

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(ogImage.src, Astro.url)} />
<meta property="og:locale" content={lang === "es" ? "es_ES" : "en_US"} />
{
	translatedPaths &&
		Object.keys(translatedPaths)
			.filter((l) => l !== lang)
			.map((l) => (
				<meta
					property="og:locale:alternate"
					content={l === "es" ? "es_ES" : "en_US"}
				/>
			))
}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(ogImage.src, Astro.url)} />
