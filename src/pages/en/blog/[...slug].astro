---
import { type CollectionEntry, getCollection, render } from "astro:content";
import BlogPost from "../../../layouts/BlogPost.astro";
import Timeline from "../../../components/Timeline.astro";
import TimelineItem from "../../../components/TimelineItem.astro";

export async function getStaticPaths() {
	const posts = await getCollection("blog", ({ id }) => id.startsWith("en/"));
	return posts.map((post) => {
		const [lang, ...idParts] = post.id.split("/");
		const slug = idParts.join("/");
		return {
			params: { slug },
			props: post,
		};
	});
}

// Redirect logic or handling if accessed via /blog/post-id without lang
// For now, Astro will handle /blog/post-id based on static paths.
// Since we want /blog/post-id for ES and /en/blog/post-id for EN,
// this file should only handle the default (ES) or be moved.
// However, a better approach for Astro is to have pages/blog/[...slug].astro
// and pages/[lang]/blog/[...slug].astro.

type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await render(post);
const components = { Timeline, TimelineItem };

// Find translations
const allPosts = await getCollection("blog");
const translations = allPosts.filter(
	(p) => p.data.id === post.data.id && post.data.id !== undefined,
);
const translatedPaths: Record<string, string> = {};
translations.forEach((p) => {
	const [pLang, ...idParts] = p.id.split("/");
	const pSlug = idParts.join("/");
	translatedPaths[pLang] =
		pLang === "es" ? `/blog/${pSlug}/` : `/en/blog/${pSlug}/`;
});
---

<BlogPost {...post.data} translatedPaths={translatedPaths}>
	<Content components={components} />
</BlogPost>
