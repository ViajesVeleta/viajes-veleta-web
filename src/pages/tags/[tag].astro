---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import PageHero from "../../components/PageHero.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../consts";
import {
    getLangFromUrl,
    useTranslations,
    useTranslatedPath,
} from "../../i18n/utils";
import { languages } from "../../i18n/ui";

export async function getStaticPaths() {
    const blogPosts = await getCollection("blog");
    const groupTrips = await getCollection("groups");
    const offers = await getCollection("offers");

    const allContent = [...blogPosts, ...groupTrips, ...offers];

    // Create paths for each tag in each language
    const paths: Array<{
        params: { lang: string | undefined; tag: string };
        props: { tag: string; lang: string };
    }> = [];
    Object.keys(languages).forEach((lang) => {
        const langContent = allContent.filter((item) =>
            item.id.startsWith(`${lang}/`),
        );
        const tags = [
            ...new Set(langContent.map((item) => item.data.tags || []).flat()),
        ];

        tags.forEach((tag) => {
            paths.push({
                params: { lang: lang === "es" ? undefined : lang, tag },
                props: { tag, lang },
            });
        });
    });

    return paths;
}

const { tag, lang: propLang } = Astro.props;
const lang = (propLang || getLangFromUrl(Astro.url)) as keyof typeof languages;
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const blogPosts = await getCollection(
    "blog",
    ({ id, data }) => id.startsWith(`${lang}/`) && data.tags?.includes(tag),
);
const groupTrips = await getCollection(
    "groups",
    ({ id, data }) => id.startsWith(`${lang}/`) && data.tags?.includes(tag),
);
const offers = await getCollection(
    "offers",
    ({ id, data }) => id.startsWith(`${lang}/`) && data.tags?.includes(tag),
);

// Map all content to a common format for display
const allTaggedContent = [
    ...blogPosts.map((p) => ({
        ...p,
        type: "blog",
        url: translatePath(`/blog/${p.id.split("/").slice(1).join("/")}/`),
    })),
    ...groupTrips.map((p) => ({
        ...p,
        type: "groups",
        url: translatePath(
            `/viajes-en-grupo/${p.id.split("/").slice(1).join("/")}/`,
        ),
    })),
    ...offers.map((p) => ({
        ...p,
        type: "offers",
        url: translatePath(`/ofertas/${p.id.split("/").slice(1).join("/")}/`),
    })),
].sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<!doctype html>
<html lang={lang} dir="ltr">
    <head>
        <BaseHead
            title={`${t("tags.intro")} "${tag}" | ${SITE_TITLE}`}
            description={SITE_DESCRIPTION}
        />
        <script>
            import { FastAverageColor } from "fast-average-color";
            const fac = new FastAverageColor();

            document.addEventListener("astro:page-load", () => {
                runColorExtraction();
            });

            document.addEventListener("DOMContentLoaded", () => {
                runColorExtraction();
            });

            function runColorExtraction() {
                const items = document.querySelectorAll(".post-item");
                items.forEach((item) => {
                    const img = item.querySelector("img");
                    const overlay = item.querySelector(
                        ".overlay",
                    ) as HTMLElement;

                    if (img && overlay) {
                        img.crossOrigin = "Anonymous";
                        fac.getColorAsync(img, { algorithm: "dominant" })
                            .then((color) => {
                                const [r, g, b] = color.value;
                                overlay.style.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.6)`;
                            })
                            .catch((e) => {
                                console.error("Color extraction failed:", e);
                                overlay.style.backgroundColor =
                                    "rgba(0,0,0,0.6)";
                            });
                    }
                });
            }
        </script>
        <style>
            main {
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 1rem;
            }
            .tag-info {
                text-align: center;
                margin: 2rem 0;
            }
            .tag-badge {
                display: inline-block;
                padding: 0.5rem 1.5rem;
                background: var(--primary);
                color: var(--on-primary);
                border-radius: 50px;
                font-weight: 600;
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }
            ul {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 4px;
                list-style-type: none;
                margin: 2rem 0;
                padding: 0;
            }
            li {
                position: relative;
                overflow: hidden;
                aspect-ratio: 4/3;
                border-radius: 12px;
                isolation: isolate;
            }
            li a {
                display: block;
                width: 100%;
                height: 100%;
                color: inherit;
                text-decoration: none;
            }
            .image-container {
                width: 100%;
                height: 100%;
                position: relative;
            }
            .image-container::after {
                content: "";
                position: absolute;
                inset: 0;
                background: linear-gradient(
                    to top,
                    rgba(0, 0, 0, 0.8) 0%,
                    transparent 60%
                );
                z-index: 1;
                transition: opacity 0.4s ease;
                pointer-events: none;
            }
            li img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            }
            .overlay {
                position: absolute;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.4);
                opacity: 0;
                transition:
                    opacity 0.4s ease,
                    background-color 0.4s ease;
                z-index: 1;
            }
            .content {
                position: absolute;
                inset: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 2rem;
                text-align: center;
                z-index: 2;
                color: white;
                transform: translateY(35%);
                transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
                pointer-events: none;
            }
            .item-type {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                margin-bottom: 0.5rem;
                background: rgba(255, 255, 255, 0.2);
                padding: 2px 8px;
                border-radius: 4px;
                backdrop-filter: blur(4px);
            }
            .title {
                font-size: 1.5rem;
                font-weight: 700;
                margin: 0 0 0.5rem 0;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
                line-height: 1.2;
                color: #fff;
            }
            .date {
                font-size: 0.9rem;
                margin: 0;
                color: rgba(255, 255, 255, 0.9);
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            }

            /* Hover Effects */
            li:hover img {
                transform: scale(1.05);
            }
            li:hover .image-container::after {
                opacity: 0;
            }
            li:hover .overlay {
                opacity: 1;
            }
            li:hover .content {
                transform: translateY(0);
            }

            @media (max-width: 768px) {
                ul {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }
                .content {
                    justify-content: flex-end;
                }
            }
        </style>
    </head>
    <body>
        <Header isOverlay={true} />
        <PageHero title={`${t("tags.tag")}: ${tag}`} />
        <main>
            <div class="tag-info">
                <span class="tag-badge">#{tag}</span>
                <p>{allTaggedContent.length} {t("tags.results")}</p>
            </div>
            <section>
                <ul>
                    {
                        allTaggedContent.map((item, index) => (
                            <li class="post-item">
                                <a href={item.url}>
                                    <div class="image-container">
                                        {item.data.heroImage && (
                                            <Image
                                                width={720}
                                                height={480}
                                                src={item.data.heroImage}
                                                alt=""
                                                loading={
                                                    index === 0
                                                        ? "eager"
                                                        : "lazy"
                                                }
                                            />
                                        )}
                                        <div class="overlay" />
                                    </div>
                                    <div class="content">
                                        <span class="item-type">
                                            {item.type === "blog"
                                                ? t("nav.blog")
                                                : item.type === "groups"
                                                  ? t("nav.trips")
                                                  : t("nav.offers")}
                                        </span>
                                        <h4 class="title">{item.data.title}</h4>
                                        <p class="date">
                                            <FormattedDate
                                                date={item.data.pubDate}
                                            />
                                        </p>
                                    </div>
                                </a>
                            </li>
                        ))
                    }
                </ul>
            </section>
        </main>
        <Footer />
    </body>
</html>
