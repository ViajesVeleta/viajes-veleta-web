name: Deploy Production

on:
  push:
    branches:
      - main

jobs:
  check-build-deploy:
    runs-on: ubuntu-latest
    name: Build & Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Checks
        id: checks
        run: |
          npm run check
          echo "checks_status=âœ… Passed" >> $GITHUB_OUTPUT

      - name: Run Tests
        id: tests
        run: |
          # Currently no tests are defined in the project
          # npm test 
          echo "tests_status=âš ï¸ No tests defined" >> $GITHUB_OUTPUT

      - name: Build
        id: build
        run: |
          npm run build
          echo "build_status=âœ… Success" >> $GITHUB_OUTPUT

      - name: Deploy to Cloudflare
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: deploy

      - name: Add Job Summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Checks | ${{ steps.checks.outputs.checks_status || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ steps.tests.outputs.tests_status || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | ${{ steps.build.outputs.build_status || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "| ðŸŒ Deployment | âœ… Successful |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Live URL:** [${{ steps.deploy.outputs.deployment-url }}](${{ steps.deploy.outputs.deployment-url }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŒ Deployment | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Commit: \`${{ github.sha }}\` by @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
